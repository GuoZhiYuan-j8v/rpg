{"version":3,"sources":["file:///C:/Users/ffgdgrrr/Desktop/rpg/assets/tools/dialog/typeScript/dialog_op.ts"],"names":["_decorator","Component","Node","TextAsset","Label","Button","Prefab","Layout","instantiate","sys","find","UITransform","Animation","Input","input","ccclass","property","dialog_op","displayName","tooltip","type","dialogindex","dialogRows","cell","index","button","jumptext","canPress","anima","actionBegin","Mask","canRestart","start","readText","csv","showDialogRow","update","deltaTime","onLoad","on","EventType","KEY_DOWN","onKeyDown","localStorage","setItem","removeItem","setAni","动画重复检测","node","play","updateText","_text","destroy","ParentAnim","setParent","getComponent","_TextAsset","text","split","onDestroy","off","event","keyCode","parseInt","getItem","onClickNext","length","console","debug","ChooseFunc","homo","homoparent","getPathInHierarchy","anchorPoint","y","setPosition","position","x","contentSize","height","log","endFunc","active","GenerateOption","onOptionClick","id","getComponentsInChildren","destroyAllChildren","DialogueChooseFunc","cell5","Restart","_index","optionButton","dd","ooc","CLICK","getComponentInChildren","string"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, TextAsset, Label, Button, Prefab, Layout, resources, instantiate, EventHandler, sys, SkelAnimDataHub, Camera, find, UITransform, tween, animation, Animation, BoxCollider2D, TERRAIN_HEIGHT_BASE, director, PolygonCollider2D, EventKeyboard, Input, KeyCode, input, VideoPlayer, Sprite } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('dialog_op')\nexport class dialog_op extends Component {\n    @property(Node)\n    homoparent:Node=null!\n    @property({displayName: \"Mask节点\", tooltip: \"用于对话显示动画\", type: Prefab})\n    ParentAnim:Prefab=null!\n    @property({displayName: \"csv对话文本文件\", tooltip: \"对话内容\", type: TextAsset})\n    csv:TextAsset=null!\n    @property(Prefab)\n    optionButton:Prefab=null!\n    @property(Layout)\n    Layout:Layout=null!\n    //跳转对话的id\n    dialogindex:number=0\n    dialogRows:string[]\n    cell: string[];\n    index: number;\n    button: Node\n    jumptext: string=null;\n    canPress: boolean=true\n    anima: string;\n    actionBegin: boolean;\n    Mask: Node=null\n    canRestart:boolean=false\n    start() {\n        this.readText(this.csv)\n        this.showDialogRow()\n    }\n    update(deltaTime:number){\n    }\n    onLoad(){\n        input.on(Input.EventType.KEY_DOWN, this.onKeyDown, this)\n        sys.localStorage.setItem('dialogActive','yes')\n        sys.localStorage.removeItem('JUMPTEXT')\n        \n    }\n    setAni(anima:string,动画重复检测:boolean,node?:Animation){\n        if(动画重复检测==true){\n            if(this.anima==anima){return}\n        }\n        this.anima=anima\n        node.play(anima)\n    }\n    updateText(_text:string){\n        if(this.Mask!=null){\n            this.Mask.destroy()\n        }\n        this.Mask=instantiate(this.ParentAnim)\n        this.Mask.setParent(find('Canvas'))\n        this.setAni('自上而下的显示',true,this.Mask.getComponent(Animation))\n        sys.localStorage.setItem('TalkText',_text)\n    }\n    readText(_TextAsset:TextAsset){\n        this.dialogRows=_TextAsset.text.split('\\n')\n    }\n    onDestroy () {\n        input.off(Input.EventType.KEY_DOWN, this.onKeyDown, this);\n    }\n\n    onKeyDown (event: EventKeyboard) {\n        switch(event.keyCode) {\n            case parseInt(sys.localStorage.getItem('next')):\n                if(this.canPress==true){\n                    this.onClickNext()\n                    \n                }\n                break;\n        }\n    }\n    showDialogRow(){\n        for (let index = 0; index < this.dialogRows.length; index++) {\n            this.cell=this.dialogRows[index].split(',')\n            if(this.cell[0]=='#'&&parseInt(this.cell[1])==this.dialogindex){\n                //对话结束后\n                console.debug(parseInt(this.cell[5]))\n                this.ChooseFunc(this.cell[5])\n                this.canPress=true\n                this.updateText(this.cell[3])\n                //寻找场景中的人物\n                let homo=find(this.homoparent.getPathInHierarchy()+'/'+this.cell[2])\n                if(homo!=null){\n                    if(homo.getComponent(UITransform).anchorPoint.y==0.5){\n                        this.Mask.setPosition(homo.position.x,homo.position.y+(homo.getComponent(UITransform).contentSize.height/2))\n                    }else{\n                        this.Mask.setPosition(homo.position.x,homo.position.y+(homo.getComponent(UITransform).contentSize.height/2+150))\n                         }\n                    }\n                console.log(this.cell[4])\n                if(this.cell[4]==''){\n                    this.endFunc()\n                    this.canRestart=true\n                    this.Mask.destroy()\n                    this.node.active=false\n                    //寻找场景中的播放字幕，如果\n                        \n                    \n                }\n                this.dialogindex=parseInt(this.cell[4])\n                break;\n            }else if(this.cell[0]=='&'&&parseInt(this.cell[1])==this.dialogindex){\n                this.canPress=false\n                this.GenerateOption(index)\n            }\n        }\n    }   \n    endFunc(){\n    }\n    onOptionClick(id:number){\n\n        this.dialogindex=id\n        this.showDialogRow()\n        for (let index = 0; index < this.Layout.getComponentsInChildren(Button).length ; index++){\n            this.Layout.node.destroyAllChildren()\n        }\n    }\n    //对话选项绑定函数\n    DialogueChooseFunc(cell5){\n        let cell=parseInt(cell5)\n    }\n    Restart(){\n        this.readText(this.csv)\n        this.dialogindex=0\n        this.cell=this.dialogRows[1].split(',')\n        if(this.canRestart==true){\n            this.showDialogRow()\n        }\n       \n    }\n    ChooseFunc(cell5){\n        let cell=parseInt(cell5)\n    }\n    GenerateOption(_index: number) {\n        while (true) {\n            this.cell = this.dialogRows[_index].split(',');\n            if (this.cell[0] == '&') {\n                this.button = instantiate(this.optionButton);\n                this.button.setParent(this.Layout.node);\n                let dd = this.cell[4];\n                let cell = this.cell[5];\n                let ooc = () => {\n                    this.DialogueChooseFunc(cell);\n                    this.onOptionClick(parseInt(dd));\n                };\n                this.button.on(Button.EventType.CLICK, ooc, this);\n                this.button.getComponentInChildren(Label).string = this.cell[3];\n                _index++;\n            } else {\n                break;\n            }\n        }\n    }\n    onClickNext(){\n        /*this.button_next.node.active=true\n        this.cell=this.dialogRows[parseInt(this.jumptext)].split(',')\n        this.dialogindex=parseInt(this.cell[4])*/\n        this.showDialogRow()\n    }\n}\n    \n"]}